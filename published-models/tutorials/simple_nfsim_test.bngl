begin model

# Multi-site binding with scaffolding - a more complex NFsim test
# Tests: multiple binding sites, cooperativity, complex formation

begin compartments
  PM   2  1.0   # plasma membrane (2D)
  Cyto 3  10.0  # cytoplasm (3D, larger volume)
end compartments

begin parameters
  # Kinetic rates
  kon_R   10.0     # receptor-ligand binding
  koff_R  0.1
  kon_K   5.0      # kinase binding to receptor
  koff_K  1.0
  kcat    2.0      # phosphorylation rate
  kdephos 0.5      # dephosphorylation rate
end parameters

begin molecule types
  L(r)                  # Ligand
  R(l,k,Y~U~P)         # Receptor with ligand site, kinase site, phospho-site
  K(r,sub~inactive~active)  # Kinase with receptor binding and activation state
end molecule types

begin seed species
  @PM:L(r)              50
  @PM:R(l,k,Y~U)        100
  @Cyto:K(r,sub~inactive) 50
end seed species

begin observables
  Molecules FreeLigand       @PM:L(r)
  Molecules BoundLigand      @PM:L(r!+)
  Molecules UnphosR          @PM:R(Y~U)
  Molecules PhosR            @PM:R(Y~P)
  Molecules LR_Complex       @PM:L(r!1).R(l!1)
  Molecules LRK_Complex      @PM:L(r!1).R(l!1,k!2).K(r!2)
  Molecules ActiveKinase     K(sub~active)
  Species   FullComplex      @PM:L(r!1).R(l!1,k!2,Y~P).K(r!2,sub~active)
end observables

begin reaction rules
  # Ligand-receptor binding
  LR_bind: @PM:L(r) + @PM:R(l) <-> @PM:L(r!1).R(l!1)  kon_R, koff_R

  # Kinase recruitment to ligand-bound receptor (cooperativity)
  K_recruit: @PM:R(l!+,k) + @Cyto:K(r) <-> @PM:R(l!+,k!1).K(r!1)  kon_K, koff_K

  # Kinase activation when bound to phosphorylated receptor
  K_activate: @PM:R(Y~P,k!1).K(r!1,sub~inactive) -> @PM:R(Y~P,k!1).K(r!1,sub~active)  kcat

  # Receptor phosphorylation by active kinase
  R_phos: @PM:R(Y~U,k!1).K(r!1,sub~active) -> @PM:R(Y~P,k!1).K(r!1,sub~active)  kcat

  # Receptor dephosphorylation (spontaneous, when unbound)
  R_dephos: @PM:R(Y~P,k) -> @PM:R(Y~U,k)  kdephos
end reaction rules

end model

simulate_nf({t_end=>50.0, n_steps=>200})
